using System.Collections.Generic;
using CJBCheatsMenu.Framework.Components;
using StardewValley;
using StardewValley.Menus;

namespace CJBCheatsMenu.Framework.Cheats.PlayerAndTools;

/// <summary>A cheat which sets the inventory size.</summary>
internal class InventorySizeCheat : BaseCheat
{
    /*********
    ** Fields
    *********/
    /// <summary>The number of items unlocked by each backpack upgrade.</summary>
    private readonly int ItemsPerBackpackUpgrade = 12;


    /*********
    ** Public methods
    *********/
    /// <inheritdoc />
    public override IEnumerable<OptionsElement> GetFields(CheatContext context)
    {
        yield return new CheatsOptionsSlider(
            label: I18n.Player_InventorySize(),
            value: Game1.player.MaxItems / this.ItemsPerBackpackUpgrade,
            minValue: 1,
            maxValue: Farmer.maxInventorySpace / this.ItemsPerBackpackUpgrade,
            setValue: this.SetBackpackSize,
            format: value => (value * this.ItemsPerBackpackUpgrade).ToString()
        );
    }


    /*********
    ** Private methods
    *********/
    /// <summary>Set the player's backpack upgrade level.</summary>
    /// <param name="level">The backpack upgrade level, starting at 1 for the starter inventory size.</param>
    /// <remarks>Derived from <see cref="Farmer.increaseBackpackSize"/>.</remarks>
    private void SetBackpackSize(int level)
    {
        Farmer player = Game1.player;
        int size = level * this.ItemsPerBackpackUpgrade;
        int difference = size - player.Items.Count;

        // set max size
        player.MaxItems = size;

        // remove extra slots
        for (int slot = player.Items.Count - 1; slot >= 0 && difference < 0; slot--)
        {
            if (player.Items[slot] == null)
            {
                player.Items.RemoveAt(slot);
                difference++;
            }
        }

        // add missing slots
        while (difference > 0)
        {
            player.Items.Add(null);
            difference--;
        }
    }
}
